@using System
@using EDScenicRouteWeb.Client.Services
@using Microsoft.AspNetCore.Blazor
@using Microsoft.AspNetCore.Blazor.Browser.Interop
@using Microsoft.AspNetCore.Blazor.Components





<div class="dropdown @(DropdownState)">
    <input class="form-control"  placeholder="@Placeholder" type="text" value="@POI" onchange="@OnChanged" oninput="(this.dispatchEvent(new CustomEvent('change', {bubbles: true})))" />
    <ul class="dropdown-menu" role="menu">
        @foreach (var poi in TypeAheadSuggestions)
        {
            <li><a href="#" onclick="@(() => POIClicked(poi))">@poi</a></li>
        }
    </ul>
</div>

@functions
{

    [Parameter]
    AppState State { get; set; }

    [Parameter]
    string Placeholder { get; set; }

    protected override void OnInit()
    {
        // If AppState is firing OnChanged then the autocomplete dropdown is no longer necessary.
        State.OnChanged += () => DropdownState = "";
    }

    public string DropdownState { get; set; } = "";

    private List<string> TypeAheadSuggestions { get; set; } = new List<string>();

    private void POIClicked(string poi)
    {
        POI = poi;
        DropdownState = "";
    }

    public string POI { get; set; } = "";

    async void OnChanged(UIChangeEventArgs args)
    {
        POI = (string)args.Value;
        if (POI.Length >= 3)
        {
            StateHasChanged();
            TypeAheadSuggestions = await State.GetPOITypeaheadSuggestions(POI);
            DropdownState = TypeAheadSuggestions.Count > 0 ? "open" : "";
            StateHasChanged();
        }
        else
        {
            DropdownState = "";
        }

    }

}
